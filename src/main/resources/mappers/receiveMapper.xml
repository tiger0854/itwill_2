<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.ddosirak.mapper.receiveMapper">
  
  <!-- 가져올 VO객체 정보 매핑 -->
	<resultMap type="com.ddosirak.domain.ReceiveVO" id="receive">
		<result property="re_code" column="re_code"/>
	</resultMap>

	<!-- 수주 등록 -->
	<insert id="receiveInsert" >
		insert into receive(re_code, item_code, customer_code, re_date, employee_id, re_qty) 
		select concat('REC', replace(current_date(), '-', ''), nullif(max(rec_id)+1, 1)),#{item_code},#{customer_code},#{re_date},#{employee_id},#{re_qty}	
		from receive
	</insert>
	<!-- 수주 등록 -->
	
	<!-- 수주 목록 -->
	<select id="receiveList" resultType="ReceiveVO">
		select *
		from receive
		order by re_date desc
		limit #{startRow}, #{pageSize}
	</select>
	<!-- 수주 목록 -->
	
	<!-- 수주 상세 -->
	<select id="receiveDetail" resultType="ReceiveVO" resultMap="receive">
		select *
		from receive
		where re_code = #{re_code}
	</select>
	<!-- 수주 상세 -->
	
	<!-- 수주 수정 -->
	<update id="receiveUpdate">
		update receive
		set re_date=#{re_date}, employee_id=#{employee_id}, re_qty=#{re_qty}
		where re_code=#{re_code}
	</update>
	<!-- 수주 수정 -->
	
	<!-- 수주 삭제 -->
	<delete id="receiveRemove">
		delete from receive
		where re_code=#{re_code}
	</delete>
	<!-- 수주 삭제 -->
  
  
  	<!-- 레시피 발주로 요청 -->
  	<select id="receiveRecodeGet" resultType="String">
	SELECT concat('REC', replace(current_date(), '-', ''), max(rec_id)) 're_code'
	FROM receive
  	
  	</select>
  	
  	<insert id="receiveRequest">
  	insert into ret_request (material_code,material_name,material_con,re_qty) 
	SELECT m.material_code , material_name,material_con, re_qty
	FROM receive r JOIN item_recipe i
	JOIN material_detail m
	WHERE r.item_code = i.item_code AND
	m.material_code = i.material_code AND
	r.re_code = #{re_code};
  	</insert>
    <!-- 레시피 발주로 요청 -->
  
  </mapper>